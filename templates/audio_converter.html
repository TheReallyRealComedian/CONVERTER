{% extends "base.html" %}

{% block title %}Audio Transcription{% endblock %}

{% block head_extra %}
<style>
    /* Styles adapted from the dossier for the microphone button */
    #mic-button {
        background: none;
        border: 1px solid var(--border-light);
        padding: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        border-radius: 50%;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    #mic-button:hover {
        background-color: var(--bg-editor-pane);
    }
    #mic-button.recording {
        color: var(--text-white);
        background-color: var(--border-danger);
        border-color: var(--border-danger);
    }
    .file-upload-wrapper {
        border: 2px dashed var(--border-dashed);
        border-radius: var(--border-radius);
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .file-upload-wrapper:hover {
        background-color: var(--bg-editor-pane);
    }
    .file-upload-wrapper p {
        margin: 0;
        font-weight: 500;
        color: var(--text-secondary);
    }
    #file-upload-input {
        display: none;
    }
    #transcription-result-container {
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: var(--bg-editor-pane);
        border: 1px solid var(--border-light);
        border-radius: var(--border-radius);
        padding: 1rem;
        min-height: 150px;
    }
    
    /* Language button styles */
    .language-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .language-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--border-light);
        background-color: var(--bg-page);
        color: var(--text-primary);
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .language-btn:hover {
        background-color: var(--bg-editor-pane);
        border-color: var(--border-focus);
    }
    .language-btn.active {
        background-color: var(--bg-primary);
        color: var(--text-white);
        border-color: var(--bg-primary);
    }
    
    /* Action button styles */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .action-btn {
        padding: 0.4rem 0.8rem;
        border: 1px solid var(--border-light);
        background-color: var(--bg-page);
        color: var(--text-primary);
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
    }
    .action-btn:hover {
        background-color: var(--bg-editor-pane);
        border-color: var(--border-focus);
    }
    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
<style>
.dialogue-line {
    background-color: var(--bg-editor-pane);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-bottom: 0.75rem;
    position: relative;
}

.dialogue-line-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.dialogue-line-number {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.dialogue-line-controls {
    display: flex;
    gap: 0.5rem;
}

.dialogue-line-btn {
    background: none;
    border: 1px solid var(--border-light);
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.dialogue-line-btn:hover {
    background-color: var(--bg-preview-pane);
    border-color: var(--border-focus);
}

.dialogue-line-btn.delete {
    color: var(--text-danger);
    border-color: var(--border-danger);
}

.dialogue-line-btn.delete:hover {
    background-color: var(--bg-alert-danger);
}

.dialogue-line-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.dialogue-line-row > * {
    flex: 1;
}

.dialogue-line textarea {
    min-height: 80px;
}
</style>
<style>
.speaker-config {
    background-color: var(--bg-page);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
}

.speaker-config-header {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.speaker-config-row {
    display: flex;
    gap: 0.5rem;
}

.speaker-config-row > div {
    flex: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h4>Audio Transcription with Deepgram</h4>
                </div>
                <div class="card-body">
                    {% if not deepgram_api_key_set %}
                    <div class="alert alert-danger">
                        <strong>Configuration Error:</strong> The `DEEPGRAM_API_KEY` is not set on the server. This service is disabled.
                    </div>
                    {% else %}
                    <!-- TABS -->
                    <ul class="nav nav-tabs" id="transcriptionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="live-tab" data-bs-toggle="tab" data-bs-target="#live-tab-pane" type="button" role="tab">Live Transcription</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-tab-pane" type="button" role="tab">Transcribe File</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="gemini-podcast-tab" data-bs-toggle="tab" data-bs-target="#gemini-podcast-tab-pane" type="button" role="tab">Gemini Podcast (Multi-Speaker)</button>
                        </li>
                    </ul>

                    <!-- SHARED CONTROLS -->
                    <div class="my-3">
                        <label class="form-label">Transcription Language</label>
                        <div class="language-buttons">
                            <button class="language-btn active" data-lang="en">English</button>
                            <button class="language-btn" data-lang="de">German</button>
                        </div>
                    </div>

                    <!-- TAB CONTENT -->
                    <div class="tab-content" id="transcriptionTabsContent">
                        <!-- LIVE TRANSCRIPTION PANE -->
                        <div class="tab-pane fade show active" id="live-tab-pane" role="tabpanel">
                            <p>Click the microphone button to start and stop real-time transcription.</p>
                            <div class="d-flex align-items-start gap-3">
                                <button id="mic-button" title="Click to Start Recording">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                                </button>
                                <div style="flex-grow: 1;">
                                    <textarea id="live-transcript-output" class="form-control" rows="8" placeholder="Live transcription will appear here..."></textarea>
                                    <div class="action-buttons">
                                        <button class="action-btn" id="copy-live-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                            Copy
                                        </button>
                                        <button class="action-btn" id="clear-live-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FILE UPLOAD PANE -->
                        <div class="tab-pane fade" id="file-tab-pane" role="tabpanel">
                            <form id="audio-upload-form">
                                <div class="mb-3">
                                    <label for="file-upload-input" class="file-upload-wrapper">
                                        <p id="file-upload-text">Click to select an audio file or drag and drop</p>
                                    </label>
                                    <input type="file" id="file-upload-input" name="audio_file" accept="audio/*" required>
                                </div>
                                <div class="d-grid mb-3">
                                    <button type="submit" class="btn btn-primary" id="transcribe-file-btn">Transcribe File</button>
                                </div>
                            </form>
                            <h5>Transcription Result:</h5>
                            <div id="transcription-result-container">
                                <span class="text-muted">The transcription will appear here after processing.</span>
                            </div>
                            <div class="action-buttons">
                                <button class="action-btn" id="copy-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                    Copy
                                </button>
                                <button class="action-btn" id="clear-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                    Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- GEMINI PODCAST PANE -->
                        <div class="tab-pane fade" id="gemini-podcast-tab-pane" role="tabpanel">
                            <p>Paste your text, describe your speakers, and let AI format it into a multi-speaker podcast.</p>
                            
                            <!-- Step 1: Configure Speakers -->
                            <div class="card mb-3" style="background-color: var(--bg-editor-pane); border: 1px solid var(--border-light);">
                                <div class="card-body">
                                    <h5 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">Step 1: Configure Speakers</h5>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="num-speakers" class="form-label">Number of Speakers</label>
                                            <select class="form-select" id="num-speakers">
                                                <option value="1">1 (Monologue)</option>
                                                <option value="2" selected>2 (Dialogue)</option>
                                                <option value="3">3 (Panel)</option>
                                                <option value="4">4 (Group)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="podcast-language" class="form-label">Language</label>
                                            <select class="form-select" id="podcast-language">
                                                <option value="en">English</option>
                                                <option value="de" selected>German (Deutsch)</option>
                                                <option value="es">Spanish (Espa√±ol)</option>
                                                <option value="fr">French (Fran√ßais)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="podcast-tone" class="form-label">Overall Tone</label>
                                            <select class="form-select" id="podcast-tone">
                                                <option value="professional and informative" selected>Professional & Informative</option>
                                                <option value="casual and friendly">Casual & Friendly</option>
                                                <option value="enthusiastic and energetic">Enthusiastic & Energetic</option>
                                                <option value="serious and thoughtful">Serious & Thoughtful</option>
                                                <option value="humorous and entertaining">Humorous & Entertaining</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="speakers-config-container">
                                        <!-- Speaker configs will be added here dynamically -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Enter Raw Text -->
                            <div class="card mb-3" style="background-color: var(--bg-editor-pane); border: 1px solid var(--border-light);">
                                <div class="card-body">
                                    <h5 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">Step 2: Enter Your Text</h5>
                                    <div class="mb-3">
                                        <label for="raw-podcast-text" class="form-label">Raw Content (just paste your text, AI will format it)</label>
                                        <textarea class="form-control" id="raw-podcast-text" rows="8" placeholder="Paste your podcast content here. No special formatting needed - just write naturally!

Example:
Today we're discussing artificial intelligence and its impact on society. AI has been developing rapidly in recent years. We've seen major breakthroughs in language models, computer vision, and robotics. But what does this mean for the average person? Well, AI is already in your smartphone, your car, and even your refrigerator..."></textarea>
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-secondary" id="format-with-ai-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path></svg>
                                            ‚ú® Format with AI
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Preview & Adjust -->
                            <div class="card mb-3" id="formatted-preview-card" style="background-color: var(--bg-editor-pane); border: 1px solid var(--border-light); display: none;">
                                <div class="card-body">
                                    <h5 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">Step 3: Preview & Adjust</h5>
                                    <div class="mb-3">
                                        <label for="formatted-dialogue-preview" class="form-label">Formatted Dialogue (you can edit if needed)</label>
                                        <textarea class="form-control" id="formatted-dialogue-preview" rows="12" style="font-family: var(--font-mono); font-size: 0.9rem;"></textarea>
                                        <div class="form-text">Format: SpeakerName [style]: Text</div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" id="generate-from-formatted-btn">
                                            üéôÔ∏è Generate Podcast
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Result Container -->
                            <div id="llm-podcast-result-container" style="display: none;">
                                <h5>Generated Podcast:</h5>
                                <audio id="llm-podcast-audio" controls style="width: 100%; margin-bottom: 1rem;">
                                    <source id="llm-podcast-audio-source" type="audio/wav">
                                    Your browser does not support the audio element.
                                </audio>
                                <div class="action-buttons">
                                    <a id="download-llm-podcast-btn" class="action-btn" download="podcast.wav">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                        Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if deepgram_api_key_set %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ==========================================================
    // ===== LANGUAGE SELECTION =====
    // ==========================================================
    const languageButtons = document.querySelectorAll('.language-btn');
    let selectedLanguage = 'en'; // Default language
    
    languageButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            languageButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            // Update selected language
            selectedLanguage = this.dataset.lang;
        });
    });
    
    // ==========================================================
    // ===== LIVE TRANSCRIPTION LOGIC (from Dossier) =====
    // ==========================================================
    const micButton = document.getElementById('mic-button');
    const transcriptOutput = document.getElementById('live-transcript-output');

    let mediaRecorder;
    let socket;
    let isRecording = false;
    let baseText = '';
    let keepAliveInterval;

    async function getDeepgramToken() {
        try {
            const response = await fetch('/api/get-deepgram-token');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to get token');
            }
            const data = await response.json();
            return data.deepgram_token;
        } catch (error) {
            console.error("Failed to get Deepgram token:", error);
            alert("Error: " + error.message);
            throw error;
        }
    }

    const connectToDeepgram = async () => {
        let deepgramToken;
        try {
            deepgramToken = await getDeepgramToken();
        } catch (error) { return; }
        
        const params = new URLSearchParams({
            model: 'nova-2',
            smart_format: 'true',
            interim_results: 'true',
            language: selectedLanguage,
            encoding: 'opus'
        });
        const deepgramUrl = `wss://api.deepgram.com/v1/listen?${params.toString()}`;

        socket = new WebSocket(deepgramUrl, ['token', deepgramToken]);

        socket.onopen = async () => {
            console.log("Deepgram socket opened.");
            baseText = transcriptOutput.value;
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' });

            mediaRecorder.addEventListener('dataavailable', event => {
                if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                    socket.send(event.data);
                }
            });

            mediaRecorder.start(250);
            isRecording = true;
            micButton.classList.add('recording');
            micButton.title = "Click to Stop Recording";
            
            // Disable language selection while recording
            languageButtons.forEach(btn => btn.disabled = true);

            keepAliveInterval = setInterval(() => {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'KeepAlive' }));
                }
            }, 5000);
        };

        socket.onmessage = (message) => {
            const received = JSON.parse(message.data);
            const transcript = received.channel?.alternatives[0]?.transcript;
            if (transcript) {
                if (received.is_final) {
                    transcriptOutput.value = baseText + transcript + ' ';
                    baseText = transcriptOutput.value;
                } else {
                    transcriptOutput.value = baseText + transcript;
                }
            }
        };

        socket.onclose = () => {
            console.log("Deepgram socket closed.");
            if (isRecording) stopRecording(false);
        };
        socket.onerror = (error) => console.error("Deepgram socket error:", error);
    };

    const stopRecording = (shouldCloseSocket = true) => {
        if (!isRecording && shouldCloseSocket) return;

        clearInterval(keepAliveInterval);

        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
        if (socket && socket.readyState === WebSocket.OPEN && shouldCloseSocket) {
            socket.close();
        }

        mediaRecorder = null;
        if (shouldCloseSocket) socket = null;
        isRecording = false;

        micButton.classList.remove('recording');
        micButton.title = "Click to Start Recording";
        
        // Re-enable language selection
        languageButtons.forEach(btn => btn.disabled = false);
        
        transcriptOutput.focus();
    };

    micButton.addEventListener('click', () => {
        if (isRecording) stopRecording();
        else connectToDeepgram();
    });

    // ==========================================================
    // ===== FILE UPLOAD TRANSCRIPTION LOGIC =====
    // ==========================================================
    const uploadForm = document.getElementById('audio-upload-form');
    const fileInput = document.getElementById('file-upload-input');
    const fileUploadText = document.getElementById('file-upload-text');
    const resultContainer = document.getElementById('transcription-result-container');
    const transcribeBtn = document.getElementById('transcribe-file-btn');

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileUploadText.textContent = fileInput.files[0].name;
        } else {
            fileUploadText.textContent = 'Click to select an audio file or drag and drop';
        }
    });
    
    uploadForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        if (!fileInput.files[0]) {
            alert("Please select an audio file first.");
            return;
        }

        const formData = new FormData();
        formData.append('audio_file', fileInput.files[0]);
        formData.append('language', selectedLanguage);

        transcribeBtn.disabled = true;
        transcribeBtn.textContent = 'Transcribing...';
        resultContainer.innerHTML = '<span class="text-muted">Processing your file...</span>';

        try {
            const response = await fetch('/transcribe-audio-file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || `HTTP error! Status: ${response.status}`);
            }
            
            resultContainer.textContent = result.transcript || 'No transcript was returned.';

        } catch (error) {
            console.error('Transcription error:', error);
            resultContainer.innerHTML = `<span class="text-danger"><strong>Error:</strong> ${error.message}</span>`;
        } finally {
            transcribeBtn.disabled = false;
            transcribeBtn.textContent = 'Transcribe File';
        }
    });
    
    // ==========================================================
    // ===== CLEAR BUTTON FUNCTIONALITY =====
    // ==========================================================
    const clearLiveBtn = document.getElementById('clear-live-btn');
    const clearFileBtn = document.getElementById('clear-file-btn');
    
    clearLiveBtn.addEventListener('click', () => {
        transcriptOutput.value = '';
        baseText = '';
    });
    
    clearFileBtn.addEventListener('click', () => {
        resultContainer.innerHTML = '<span class="text-muted">The transcription will appear here after processing.</span>';
    });
    
    // ==========================================================
    // ===== COPY TO CLIPBOARD FUNCTIONALITY =====
    // ==========================================================
    const copyLiveBtn = document.getElementById('copy-live-btn');
    const copyFileBtn = document.getElementById('copy-file-btn');
    
    async function copyToClipboard(text, button) {
        if (!text || text.trim() === '') {
            alert('Nothing to copy!');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(text);
            // Visual feedback
            const originalText = button.innerHTML;
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
            button.style.backgroundColor = 'var(--bg-alert-success)';
            button.style.color = 'var(--text-success)';
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.backgroundColor = '';
                button.style.color = '';
            }, 2000);
        } catch (err) {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        }
    }
    
    copyLiveBtn.addEventListener('click', () => {
        copyToClipboard(transcriptOutput.value, copyLiveBtn);
    });
    
    copyFileBtn.addEventListener('click', () => {
        const text = resultContainer.textContent;
        copyToClipboard(text, copyFileBtn);
    });

});
</script>
<script>
// ==========================================================
// ===== LLM-POWERED PODCAST GENERATOR =====
// ==========================================================

const numSpeakersSelect = document.getElementById('num-speakers');
const speakersConfigContainer = document.getElementById('speakers-config-container');
const podcastLanguageSelect = document.getElementById('podcast-language');
const podcastToneSelect = document.getElementById('podcast-tone');
const rawPodcastTextInput = document.getElementById('raw-podcast-text');
const formatWithAiBtn = document.getElementById('format-with-ai-btn');
const formattedPreviewCard = document.getElementById('formatted-preview-card');
const formattedDialoguePreview = document.getElementById('formatted-dialogue-preview');
const generateFromFormattedBtn = document.getElementById('generate-from-formatted-btn');
const llmPodcastResultContainer = document.getElementById('llm-podcast-result-container');
const llmPodcastAudio = document.getElementById('llm-podcast-audio');
const llmPodcastAudioSource = document.getElementById('llm-podcast-audio-source');
const downloadLlmPodcastBtn = document.getElementById('download-llm-podcast-btn');

// Voice options organized by gender
const geminiVoiceOptions = {
    female: ['Zephyr', 'Leda', 'Laomedeia', 'Aoede', 'Callirrhoe', 'Autonoe', 'Erinome', 'Umbriel', 'Despina', 'Pulcherrima', 'Vindemiatrix'],
    male: ['Kore', 'Charon', 'Fenrir', 'Orus', 'Puck', 'Enceladus', 'Iapetus', 'Algenib', 'Achernar', 'Algieba', 'Gacrux', 'Alnilam', 'Rasalgethi', 'Sadaltager', 'Zubenelgenubi'],
    neutral: ['Kore', 'Achird', 'Schedar', 'Sadachbia', 'Sulafat']
};

const defaultSpeakers = [
    { name: 'Anna', voice: 'Zephyr', personality: 'friendly and enthusiastic' },
    { name: 'Max', voice: 'Charon', personality: 'professional and informative' },
    { name: 'Sarah', voice: 'Leda', personality: 'curious and thoughtful' },
    { name: 'Tom', voice: 'Puck', personality: 'upbeat and humorous' }
];

function createSpeakerConfig(index) {
    const speaker = defaultSpeakers[index] || { name: `Speaker${index + 1}`, voice: 'Kore', personality: 'neutral' };
    
    const configDiv = document.createElement('div');
    configDiv.className = 'speaker-config';
    configDiv.dataset.speakerIndex = index;
    
    configDiv.innerHTML = `
        <div class="speaker-config-header">Speaker ${index + 1}</div>
        <div class="speaker-config-row">
            <div>
                <label class="form-label" style="font-size: 0.8rem;">Name</label>
                <input type="text" class="form-control form-control-sm speaker-name" value="${speaker.name}">
            </div>
            <div>
                <label class="form-label" style="font-size: 0.8rem;">Voice</label>
                <select class="form-select form-select-sm speaker-voice">
                    <optgroup label="Female">
                        ${geminiVoiceOptions.female.map(v => `<option value="${v}" ${v === speaker.voice ? 'selected' : ''}>${v}</option>`).join('')}
                    </optgroup>
                    <optgroup label="Male">
                        ${geminiVoiceOptions.male.map(v => `<option value="${v}" ${v === speaker.voice ? 'selected' : ''}>${v}</option>`).join('')}
                    </optgroup>
                    <optgroup label="Neutral">
                        ${geminiVoiceOptions.neutral.map(v => `<option value="${v}" ${v === speaker.voice ? 'selected' : ''}>${v}</option>`).join('')}
                    </optgroup>
                </select>
            </div>
            <div>
                <label class="form-label" style="font-size: 0.8rem;">Personality</label>
                <input type="text" class="form-control form-control-sm speaker-personality" value="${speaker.personality}" placeholder="e.g., friendly, professional...">
            </div>
        </div>
    `;
    
    return configDiv;
}

function updateSpeakerConfigs() {
    const numSpeakers = parseInt(numSpeakersSelect.value);
    speakersConfigContainer.innerHTML = '';
    
    for (let i = 0; i < numSpeakers; i++) {
        speakersConfigContainer.appendChild(createSpeakerConfig(i));
    }
}

function collectSpeakerDescriptions() {
    const configs = speakersConfigContainer.querySelectorAll('.speaker-config');
    const descriptions = [];
    
    configs.forEach(config => {
        descriptions.push({
            name: config.querySelector('.speaker-name').value.trim(),
            voice: config.querySelector('.speaker-voice').value,
            personality: config.querySelector('.speaker-personality').value.trim()
        });
    });
    
    return descriptions;
}

// Initialize with 2 speakers
numSpeakersSelect.addEventListener('change', updateSpeakerConfigs);
updateSpeakerConfigs();

// Format with AI
formatWithAiBtn.addEventListener('click', async () => {
    const rawText = rawPodcastTextInput.value.trim();
    
    if (!rawText) {
        alert('Please enter some text to format.');
        return;
    }
    
    formatWithAiBtn.disabled = true;
    formatWithAiBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Formatting with AI...';
    
    try {
        const response = await fetch('/format-dialogue-with-llm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                raw_text: rawText,
                num_speakers: parseInt(numSpeakersSelect.value),
                speaker_descriptions: collectSpeakerDescriptions(),
                language: podcastLanguageSelect.value,
                tone: podcastToneSelect.value
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Show the formatted dialogue
        formattedDialoguePreview.value = data.raw_formatted_text;
        formattedPreviewCard.style.display = 'block';
        
        // Scroll to preview
        formattedPreviewCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
    } catch (error) {
        console.error('Formatting error:', error);
        alert('Error formatting dialogue: ' + error.message);
    } finally {
        formatWithAiBtn.disabled = false;
        formatWithAiBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path></svg> ‚ú® Format with AI';
    }
});

// Generate podcast from formatted dialogue
generateFromFormattedBtn.addEventListener('click', async () => {
    const formattedText = formattedDialoguePreview.value.trim();
    
    if (!formattedText) {
        alert('No formatted dialogue to generate.');
        return;
    }
    
    // Parse the formatted text into dialogue array
    const dialogue = [];
    const speakerDescriptions = collectSpeakerDescriptions();
    const speakerVoiceMap = {};
    speakerDescriptions.forEach(desc => {
        speakerVoiceMap[desc.name] = desc.voice;
    });
    
    for (const line of formattedText.split('\n')) {
        const trimmedLine = line.trim();
        if (!trimmedLine || trimmedLine.startsWith('#') || trimmedLine.startsWith('**')) {
            continue;
        }
        
        if (trimmedLine.includes(':')) {
            const parts = trimmedLine.split(':', 1);
            const speakerPart = parts[0].trim();
            const textPart = trimmedLine.substring(parts[0].length + 1).trim();
            
            let speaker = speakerPart;
            let style = '';
            
            // Extract style if present
            if (speakerPart.includes('[') && speakerPart.includes(']')) {
                speaker = speakerPart.split('[')[0].trim();
                style = speakerPart.split('[')[1].split(']')[0].trim();
            }
            
            // Map speaker name to voice
            const voice = speakerVoiceMap[speaker] || 'Kore';
            
            if (textPart) {
                dialogue.push({
                    speaker: voice,  // Use the voice name directly
                    style: style,
                    text: textPart
                });
            }
        }
    }
    
    if (dialogue.length === 0) {
        alert('Could not parse any dialogue. Please check the format.');
        return;
    }
    
    generateFromFormattedBtn.disabled = true;
    generateFromFormattedBtn.textContent = 'üéôÔ∏è Generating...';
    llmPodcastResultContainer.style.display = 'none';
    
    try {
        const response = await fetch('/generate-gemini-podcast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dialogue: dialogue,
                language: podcastLanguageSelect.value
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }
        
        // Get the audio blob
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        // Update audio player
        llmPodcastAudioSource.src = audioUrl;
        llmPodcastAudio.load();
        
        // Update download link
        downloadLlmPodcastBtn.href = audioUrl;
        
        // Show result container
        llmPodcastResultContainer.style.display = 'block';
        llmPodcastResultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
    } catch (error) {
        console.error('Podcast generation error:', error);
        alert('Error generating podcast: ' + error.message);
    } finally {
        generateFromFormattedBtn.disabled = false;
        generateFromFormattedBtn.textContent = 'üéôÔ∏è Generate Podcast';
    }
});
</script>
{% endif %}
{% endblock %}