{% extends "base.html" %}

{% block title %}Audio Transcription{% endblock %}

{% block head_extra %}
<style>
    /* Styles adapted from the dossier for the microphone button */
    #mic-button {
        background: none;
        border: 1px solid var(--border-light);
        padding: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        border-radius: 50%;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    #mic-button:hover {
        background-color: var(--bg-editor-pane);
    }
    #mic-button.recording {
        color: var(--text-white);
        background-color: var(--border-danger);
        border-color: var(--border-danger);
    }
    .file-upload-wrapper {
        border: 2px dashed var(--border-dashed);
        border-radius: var(--border-radius);
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .file-upload-wrapper:hover {
        background-color: var(--bg-editor-pane);
    }
    .file-upload-wrapper p {
        margin: 0;
        font-weight: 500;
        color: var(--text-secondary);
    }
    #file-upload-input {
        display: none;
    }
    #transcription-result-container {
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: var(--bg-editor-pane);
        border: 1px solid var(--border-light);
        border-radius: var(--border-radius);
        padding: 1rem;
        min-height: 150px;
    }
    
    /* Language button styles */
    .language-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .language-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--border-light);
        background-color: var(--bg-page);
        color: var(--text-primary);
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .language-btn:hover {
        background-color: var(--bg-editor-pane);
        border-color: var(--border-focus);
    }
    .language-btn.active {
        background-color: var(--bg-primary);
        color: var(--text-white);
        border-color: var(--bg-primary);
    }
    
    /* Action button styles */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .action-btn {
        padding: 0.4rem 0.8rem;
        border: 1px solid var(--border-light);
        background-color: var(--bg-page);
        color: var(--text-primary);
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
    }
    .action-btn:hover {
        background-color: var(--bg-editor-pane);
        border-color: var(--border-focus);
    }
    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
<style>
.dialogue-line {
    background-color: var(--bg-editor-pane);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-bottom: 0.75rem;
    position: relative;
}

.dialogue-line-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.dialogue-line-number {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.dialogue-line-controls {
    display: flex;
    gap: 0.5rem;
}

.dialogue-line-btn {
    background: none;
    border: 1px solid var(--border-light);
    padding: 0.25rem 0.5rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.dialogue-line-btn:hover {
    background-color: var(--bg-preview-pane);
    border-color: var(--border-focus);
}

.dialogue-line-btn.delete {
    color: var(--text-danger);
    border-color: var(--border-danger);
}

.dialogue-line-btn.delete:hover {
    background-color: var(--bg-alert-danger);
}

.dialogue-line-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.dialogue-line-row > * {
    flex: 1;
}

.dialogue-line textarea {
    min-height: 80px;
}
</style>
<style>
.speaker-config {
    background-color: var(--bg-page);
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
}

.speaker-config-header {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.speaker-config-row {
    display: flex;
    gap: 0.5rem;
}

.speaker-config-row > div {
    flex: 1;
}

/* NEW: Mode selector styles */
.mode-selector {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.mode-btn {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid var(--border-light);
    background-color: var(--bg-page);
    color: var(--text-primary);
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    text-align: center;
}

.mode-btn:hover {
    background-color: var(--bg-editor-pane);
    border-color: var(--border-focus);
}

.mode-btn.active {
    background-color: var(--bg-primary);
    color: var(--text-white);
    border-color: var(--bg-primary);
}

/* NEW: Collapsible prompt editor */
.prompt-editor-section {
    margin-top: 1rem;
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius);
    background-color: var(--bg-page);
}

.prompt-editor-header {
    padding: 0.75rem;
    background-color: var(--bg-editor-pane);
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
}

.prompt-editor-header:hover {
    background-color: #e0e2e5;
}

.prompt-editor-content {
    padding: 0.75rem;
    display: none;
}

.prompt-editor-content.expanded {
    display: block;
}

.prompt-textarea {
    width: 100%;
    min-height: 200px;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    padding: 0.5rem;
    border: 1px solid var(--border-light);
    border-radius: var(--border-radius);
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h4>Audio Transcription with Deepgram</h4>
                </div>
                <div class="card-body">
                    {% if not deepgram_api_key_set %}
                    <div class="alert alert-danger">
                        <strong>Configuration Error:</strong> The `DEEPGRAM_API_KEY` is not set on the server. This service is disabled.
                    </div>
                    {% else %}
                    <!-- TABS -->
                    <ul class="nav nav-tabs" id="transcriptionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="live-tab" data-bs-toggle="tab" data-bs-target="#live-tab-pane" type="button" role="tab">Live Transcription</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-tab-pane" type="button" role="tab">Transcribe File</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="gemini-podcast-tab" data-bs-toggle="tab" data-bs-target="#gemini-podcast-tab-pane" type="button" role="tab">Gemini Podcast (Multi-Speaker)</button>
                        </li>
                    </ul>

                    <!-- SHARED CONTROLS -->
                    <div class="my-3">
                        <label class="form-label">Transcription Language</label>
                        <div class="language-buttons">
                            <button class="language-btn active" data-lang="en">English</button>
                            <button class="language-btn" data-lang="de">German</button>
                        </div>
                    </div>

                    <!-- TAB CONTENT -->
                    <div class="tab-content" id="transcriptionTabsContent">
                        <!-- LIVE TRANSCRIPTION PANE -->
                        <div class="tab-pane fade show active" id="live-tab-pane" role="tabpanel">
                            <p>Click the microphone button to start and stop real-time transcription.</p>
                            <div class="d-flex align-items-start gap-3">
                                <button id="mic-button" title="Click to Start Recording">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                                </button>
                                <div style="flex-grow: 1;">
                                    <textarea id="live-transcript-output" class="form-control" rows="8" placeholder="Live transcription will appear here..."></textarea>
                                    <div class="action-buttons">
                                        <button class="action-btn" id="copy-live-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                            Copy
                                        </button>
                                        <button class="action-btn" id="clear-live-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FILE UPLOAD PANE -->
                        <div class="tab-pane fade" id="file-tab-pane" role="tabpanel">
                            <form id="audio-upload-form">
                                <div class="mb-3">
                                    <label for="file-upload-input" class="file-upload-wrapper">
                                        <p id="file-upload-text">Click to select an audio file or drag and drop</p>
                                    </label>
                                    <input type="file" id="file-upload-input" name="audio_file" accept="audio/*" required>
                                </div>
                                <div class="d-grid mb-3">
                                    <button type="submit" class="btn btn-primary" id="transcribe-file-btn">Transcribe File</button>
                                </div>
                            </form>
                            <h5>Transcription Result:</h5>
                            <div id="transcription-result-container">
                                <span class="text-muted">The transcription will appear here after processing.</span>
                            </div>
                            <div class="action-buttons">
                                <button class="action-btn" id="copy-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                    Copy
                                </button>
                                <button class="action-btn" id="clear-file-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                    Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- GEMINI PODCAST PANE -->
                        <div class="tab-pane fade" id="gemini-podcast-tab-pane" role="tabpanel">
                            <p>Create a multi-speaker podcast or single-speaker narration: Configure speakers, then either let AI format your text or write your own script.</p>
                            
                            <!-- Step 1: Configure Speakers -->
                            <div class="card mb-3" style="background-color: var(--bg-editor-pane); border: 1px solid var(--border-light);">
                                <div class="card-body">
                                    <h5 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">Step 1: Configure Speakers</h5>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="num-speakers" class="form-label">Number of Speakers</label>
                                            <select class="form-select" id="num-speakers">
                                                <option value="1">1 (Monologue/Narration)</option>
                                                <option value="2" selected>2 (Dialogue)</option>
                                                <option value="3">3 (Panel)</option>
                                                <option value="4">4 (Group)</option>
                                            </select>
                                            <div class="form-text" style="font-size: 0.75rem;">Note: Gemini TTS supports 1-4 speakers</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="podcast-language" class="form-label">Language</label>
                                            <select class="form-select" id="podcast-language">
                                                <option value="en">English</option>
                                                <option value="de" selected>German (Deutsch)</option>
                                                <option value="es">Spanish (Espa√±ol)</option>
                                                <option value="fr">French (Fran√ßais)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="podcast-tone" class="form-label">Overall Tone</label>
                                            <select class="form-select" id="podcast-tone">
                                                <option value="professional and informative" selected>Professional & Informative</option>
                                                <option value="casual and friendly">Casual & Friendly</option>
                                                <option value="enthusiastic and energetic">Enthusiastic & Energetic</option>
                                                <option value="serious and thoughtful">Serious & Thoughtful</option>
                                                <option value="humorous and entertaining">Humorous & Entertaining</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="speakers-config-container">
                                        <!-- Speaker configs will be added here dynamically -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 2: Choose Mode -->
                            <div class="card mb-3" style="background-color: var(--bg-editor-pane); border: 1px solid var(--border-light);">
                                <div class="card-body">
                                    <h5 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">Step 2: Create Your Script</h5>
                                    
                                    <!-- Mode Selector -->
                                    <label class="form-label">Choose Creation Mode:</label>
                                    <div class="mode-selector">
                                        <button class="mode-btn active" data-mode="ai">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 0.3rem;"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path></svg>
                                            AI-Assisted<br><small style="font-size: 0.75rem; font-weight: normal;">Let AI format your text</small>
                                        </button>
                                        <button class="mode-btn" data-mode="manual">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 0.3rem;"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                            Manual Script<br><small style="font-size: 0.75rem; font-weight: normal;">Write your own dialogue</small>
                                        </button>
                                    </div>
                                    
                                    <!-- AI Mode Content -->
                                    <div id="ai-mode-content" style="display: block;">
                                        <div class="mb-3 mt-3">
                                            <label for="prompt-preset" class="form-label">Prompt Style</label>
                                            <select class="form-select" id="prompt-preset">
                                                <option value="verbatim">Verbatim (W√∂rtlich) - Minimal changes, just format</option>
                                                <option value="natural">Natural - Light conversational touch</option>
                                                <option value="conversational" selected>Conversational - Standard engaging dialogue</option>
                                                <option value="creative">Creative - Enhanced with examples & depth</option>
                                            </select>
                                            <div class="form-text" style="font-size: 0.75rem;">Choose how much the AI should modify your text</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="script-length" class="form-label">Desired Script Length</label>
                                            <select class="form-select" id="script-length">
                                                <option value="short">Short (~2-3 minutes, ~300-500 words)</option>
                                                <option value="medium" selected>Medium (~5-7 minutes, ~800-1200 words)</option>
                                                <option value="long">Long (~10-15 minutes, ~1500-2500 words)</option>
                                                <option value="very-long">Very Long (~20-30 minutes, ~3000-5000 words)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="raw-podcast-text" class="form-label">Raw Content</label>
                                            <textarea class="form-control" id="raw-podcast-text" rows="8" placeholder="Paste your podcast content here. No special formatting needed - just write naturally!

Example:
Today we're discussing artificial intelligence and its impact on society. AI has been developing rapidly in recent years. We've seen major breakthroughs in language models, computer vision, and robotics. But what does this mean for the average person? Well, AI is already in your smartphone, your car, and even your refrigerator..."></textarea>
                                        </div>
                                        
                                        <!-- Collapsible System Prompt Editor -->
                                        <div class="prompt-editor-section">
                                            <div class="prompt-editor-header" id="prompt-editor-toggle">
                                                <span>‚öôÔ∏è Advanced: Edit System Prompt</span>
                                                <span id="prompt-toggle-icon">‚ñº</span>
                                            </div>
                                            <div class="prompt-editor-content" id="prompt-editor-content">
                                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                                    This is the instruction given to the AI. You can customize it to change how the script is generated.
                                                </p>
                                                <textarea class="prompt-textarea" id="system-prompt-editor">You are a podcast script formatter. Convert the following raw text into a structured dialogue script.

**Context:**
- Number of speakers: {num_speakers}
- Language: {language_name}
- Overall tone: {tone}
- Target length: {target_length}
- Speakers:
{speakers_info}

**Raw Text to Convert:**
{raw_text}

**Instructions:**
1. Create a natural, engaging {target_length_desc} podcast script from the raw text
2. Split the content naturally into dialogue turns between the {num_speakers} speaker(s)
3. Each turn should be 1-4 sentences for natural conversational flow
4. Add appropriate style hints in square brackets (e.g., enthusiastically, calmly, thoughtfully)
5. Make it conversational, engaging, and maintain the {tone} tone
6. Use the exact speaker names provided above
7. IMPORTANT: Generate enough content to match the target length. Don't be brief - expand on topics naturally.
8. Include transitions, questions, clarifications, and natural back-and-forth between speakers

**Output Format (one line per dialogue turn):**
SpeakerName [style]: Text of what they say

**Example:**
Anna [enthusiastically]: Welcome to our show!
Max [professionally]: Today we discuss artificial intelligence and how it's changing our world.
Anna [curiously]: What makes it so revolutionary? Can you break it down for our listeners?
Max [thoughtfully]: Great question. Let me start with the basics...

Now convert the raw text above into this format. Remember to generate {target_length_desc} content!</textarea>
                                                <button class="btn btn-secondary btn-sm mt-2" id="reset-prompt-btn">Reset to Default</button>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid mt-3">
                                            <button type="button" class="btn btn-secondary" id="format-with-ai-btn">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path></svg>
                                                ‚ú® Format with AI
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Manual Mode Content -->
                                    <div id="manual-mode-content" style="display: none;">
                                        <div class="alert alert-info mt-3" style="font-size: 0.9rem;">
                                            <strong>Format Instructions:</strong> Write one line per speaker turn in this format:<br>
                                            <code>SpeakerName [optional-style]: What they say</code><br><br>
                                            <strong>Example:</strong><br>
                                            <code>Anna [enthusiastically]: Welcome everyone!</code><br>
                                            <code>Max: Today we're discussing AI.</code><br><br>
                                            <strong>For single speaker (monologue):</strong><br>
                                            <code>Narrator [warmly]: Today I'll tell you about...</code>
                                        </div>
                                        <div class="mb-3">
                                            <label for="manual-script-input" class="form-label">Your Formatted Script</label>
                                            <textarea class="form-control" id="manual-script-input" rows="15" style="font-family: var(--font-mono); font-size: 0.9rem;" placeholder="Anna [enthusiastically]: Welcome to our podcast!
Max [professionally]: Today we're discussing an important topic.
Anna [curiously]: Can you tell us more about it?
Max [thoughtfully]: Of course! Let me explain..."></textarea>
                                        </div>
                                        <div class="d-grid">
                                            <button type="button" class="btn btn-primary" id="use-manual-script-btn">
                                                üìù Use This Script
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Step 3: Preview & Generate -->
                            <div class="card mb-3" id="formatted-preview-card" style="background-color: var(--bg-editor-pane); border: 1px solid var(--border-light); display: none;">
                                <div class="card-body">
                                    <h5 class="card-title" style="font-size: 1rem; margin-bottom: 1rem;">Step 3: Preview & Generate</h5>
                                    <div class="mb-3">
                                        <label for="formatted-dialogue-preview" class="form-label">Formatted Dialogue (you can edit if needed)</label>
                                        <textarea class="form-control" id="formatted-dialogue-preview" rows="12" style="font-family: var(--font-mono); font-size: 0.9rem;"></textarea>
                                        <div class="form-text">Format: SpeakerName [style]: Text</div>
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" id="generate-from-formatted-btn">
                                            üéôÔ∏è Generate Podcast
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Result Container -->
                            <div id="llm-podcast-result-container" style="display: none;">
                                <h5>Generated Podcast:</h5>
                                <audio id="llm-podcast-audio" controls style="width: 100%; margin-bottom: 1rem;">
                                    <source id="llm-podcast-audio-source" type="audio/wav">
                                    Your browser does not support the audio element.
                                </audio>
                                <div class="action-buttons">
                                    <a id="download-llm-podcast-btn" class="action-btn" download="podcast.wav">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                        Download
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if deepgram_api_key_set %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ==========================================================
    // ===== LANGUAGE SELECTION =====
    // ==========================================================
    const languageButtons = document.querySelectorAll('.language-btn');
    let selectedLanguage = 'en';
    
    languageButtons.forEach(button => {
        button.addEventListener('click', function() {
            languageButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            selectedLanguage = this.dataset.lang;
        });
    });
    
    // ==========================================================
    // ===== LIVE TRANSCRIPTION LOGIC (from Dossier) =====
    // ==========================================================
    const micButton = document.getElementById('mic-button');
    const transcriptOutput = document.getElementById('live-transcript-output');

    let mediaRecorder;
    let socket;
    let isRecording = false;
    let baseText = '';
    let keepAliveInterval;

    async function getDeepgramToken() {
        try {
            const response = await fetch('/api/get-deepgram-token');
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to get token');
            }
            const data = await response.json();
            return data.deepgram_token;
        } catch (error) {
            console.error("Failed to get Deepgram token:", error);
            alert("Error: " + error.message);
            throw error;
        }
    }

    const connectToDeepgram = async () => {
        let deepgramToken;
        try {
            deepgramToken = await getDeepgramToken();
        } catch (error) { return; }
        
        const params = new URLSearchParams({
            model: 'nova-2',
            smart_format: 'true',
            interim_results: 'true',
            language: selectedLanguage,
            encoding: 'opus'
        });
        const deepgramUrl = `wss://api.deepgram.com/v1/listen?${params.toString()}`;

        socket = new WebSocket(deepgramUrl, ['token', deepgramToken]);

        socket.onopen = async () => {
            console.log("Deepgram socket opened.");
            baseText = transcriptOutput.value;
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=opus' });

            mediaRecorder.addEventListener('dataavailable', event => {
                if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                    socket.send(event.data);
                }
            });

            mediaRecorder.start(250);
            isRecording = true;
            micButton.classList.add('recording');
            micButton.title = "Click to Stop Recording";
            
            languageButtons.forEach(btn => btn.disabled = true);

            keepAliveInterval = setInterval(() => {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'KeepAlive' }));
                }
            }, 5000);
        };

        socket.onmessage = (message) => {
            const received = JSON.parse(message.data);
            const transcript = received.channel?.alternatives[0]?.transcript;
            if (transcript) {
                if (received.is_final) {
                    transcriptOutput.value = baseText + transcript + ' ';
                    baseText = transcriptOutput.value;
                } else {
                    transcriptOutput.value = baseText + transcript;
                }
            }
        };

        socket.onclose = () => {
            console.log("Deepgram socket closed.");
            if (isRecording) stopRecording(false);
        };
        socket.onerror = (error) => console.error("Deepgram socket error:", error);
    };

    const stopRecording = (shouldCloseSocket = true) => {
        if (!isRecording && shouldCloseSocket) return;

        clearInterval(keepAliveInterval);

        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
        if (socket && socket.readyState === WebSocket.OPEN && shouldCloseSocket) {
            socket.close();
        }

        mediaRecorder = null;
        if (shouldCloseSocket) socket = null;
        isRecording = false;

        micButton.classList.remove('recording');
        micButton.title = "Click to Start Recording";
        
        languageButtons.forEach(btn => btn.disabled = false);
        
        transcriptOutput.focus();
    };

    micButton.addEventListener('click', () => {
        if (isRecording) stopRecording();
        else connectToDeepgram();
    });

    // ==========================================================
    // ===== FILE UPLOAD TRANSCRIPTION LOGIC =====
    // ==========================================================
    const uploadForm = document.getElementById('audio-upload-form');
    const fileInput = document.getElementById('file-upload-input');
    const fileUploadText = document.getElementById('file-upload-text');
    const resultContainer = document.getElementById('transcription-result-container');
    const transcribeBtn = document.getElementById('transcribe-file-btn');

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            fileUploadText.textContent = fileInput.files[0].name;
        } else {
            fileUploadText.textContent = 'Click to select an audio file or drag and drop';
        }
    });
    
    uploadForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        if (!fileInput.files[0]) {
            alert("Please select an audio file first.");
            return;
        }

        const formData = new FormData();
        formData.append('audio_file', fileInput.files[0]);
        formData.append('language', selectedLanguage);

        transcribeBtn.disabled = true;
        transcribeBtn.textContent = 'Transcribing...';
        resultContainer.innerHTML = '<span class="text-muted">Processing your file...</span>';

        try {
            const response = await fetch('/transcribe-audio-file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || `HTTP error! Status: ${response.status}`);
            }
            
            resultContainer.textContent = result.transcript || 'No transcript was returned.';

        } catch (error) {
            console.error('Transcription error:', error);
            resultContainer.innerHTML = `<span class="text-danger"><strong>Error:</strong> ${error.message}</span>`;
        } finally {
            transcribeBtn.disabled = false;
            transcribeBtn.textContent = 'Transcribe File';
        }
    });
    
    // ==========================================================
    // ===== CLEAR BUTTON FUNCTIONALITY =====
    // ==========================================================
    const clearLiveBtn = document.getElementById('clear-live-btn');
    const clearFileBtn = document.getElementById('clear-file-btn');
    
    clearLiveBtn.addEventListener('click', () => {
        transcriptOutput.value = '';
        baseText = '';
    });
    
    clearFileBtn.addEventListener('click', () => {
        resultContainer.innerHTML = '<span class="text-muted">The transcription will appear here after processing.</span>';
    });
    
    // ==========================================================
    // ===== COPY TO CLIPBOARD FUNCTIONALITY =====
    // ==========================================================
    const copyLiveBtn = document.getElementById('copy-live-btn');
    const copyFileBtn = document.getElementById('copy-file-btn');
    
    async function copyToClipboard(text, button) {
        if (!text || text.trim() === '') {
            alert('Nothing to copy!');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(text);
            const originalText = button.innerHTML;
            button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
            button.style.backgroundColor = 'var(--bg-alert-success)';
            button.style.color = 'var(--text-success)';
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.backgroundColor = '';
                button.style.color = '';
            }, 2000);
        } catch (err) {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        }
    }
    
    copyLiveBtn.addEventListener('click', () => {
        copyToClipboard(transcriptOutput.value, copyLiveBtn);
    });
    
    copyFileBtn.addEventListener('click', () => {
        const text = resultContainer.textContent;
        copyToClipboard(text, copyFileBtn);
    });

});
</script>
<script>
// ==========================================================
// ===== LLM-POWERED PODCAST GENERATOR =====
// ==========================================================

const numSpeakersSelect = document.getElementById('num-speakers');
const speakersConfigContainer = document.getElementById('speakers-config-container');
const podcastLanguageSelect = document.getElementById('podcast-language');
const podcastToneSelect = document.getElementById('podcast-tone');
const scriptLengthSelect = document.getElementById('script-length');
const rawPodcastTextInput = document.getElementById('raw-podcast-text');
const formatWithAiBtn = document.getElementById('format-with-ai-btn');
const formattedPreviewCard = document.getElementById('formatted-preview-card');
const formattedDialoguePreview = document.getElementById('formatted-dialogue-preview');
const generateFromFormattedBtn = document.getElementById('generate-from-formatted-btn');
const llmPodcastResultContainer = document.getElementById('llm-podcast-result-container');
const llmPodcastAudio = document.getElementById('llm-podcast-audio');
const llmPodcastAudioSource = document.getElementById('llm-podcast-audio-source');
const downloadLlmPodcastBtn = document.getElementById('download-llm-podcast-btn');

const modeButtons = document.querySelectorAll('.mode-btn');
const aiModeContent = document.getElementById('ai-mode-content');
const manualModeContent = document.getElementById('manual-mode-content');
const manualScriptInput = document.getElementById('manual-script-input');
const useManualScriptBtn = document.getElementById('use-manual-script-btn');

const promptEditorToggle = document.getElementById('prompt-editor-toggle');
const promptEditorContent = document.getElementById('prompt-editor-content');
const promptToggleIcon = document.getElementById('prompt-toggle-icon');
const systemPromptEditor = document.getElementById('system-prompt-editor');
const resetPromptBtn = document.getElementById('reset-prompt-btn');
const promptPresetSelect = document.getElementById('prompt-preset');

let currentMode = 'ai';

const geminiVoiceOptions = {
    female: ['Zephyr', 'Leda', 'Laomedeia', 'Aoede', 'Callirrhoe', 'Autonoe', 'Erinome', 'Umbriel', 'Despina', 'Pulcherrima', 'Vindemiatrix'],
    male: ['Kore', 'Charon', 'Fenrir', 'Orus', 'Puck', 'Enceladus', 'Iapetus', 'Algenib', 'Achernar', 'Algieba', 'Gacrux', 'Alnilam', 'Rasalgethi', 'Sadaltager', 'Zubenelgenubi'],
    neutral: ['Kore', 'Achird', 'Schedar', 'Sadachbia', 'Sulafat']
};

// UPDATED: Now includes default for single speaker
const defaultSpeakers = [
    { name: 'Narrator', voice: 'Kore', personality: 'professional and clear' }, // Single speaker
    { name: 'Anna', voice: 'Zephyr', personality: 'friendly and enthusiastic' },
    { name: 'Max', voice: 'Charon', personality: 'professional and informative' },
    { name: 'Sarah', voice: 'Leda', personality: 'curious and thoughtful' },
    { name: 'Tom', voice: 'Puck', personality: 'upbeat and humorous' }
];

// ===== PROMPT TEMPLATES =====
const promptTemplates = {
    // VERBATIM: Minimal changes, just format into dialogue
    verbatim: {
        single: `You are a text formatter. Convert the following raw text into a narration format with MINIMAL changes.

**Context:**
- Single speaker (monologue)
- Language: {language_name}
- Target length: Match the original text length as closely as possible
- Speaker: {speakers_info}

**Raw Text to Convert:**
{raw_text}

**CRITICAL INSTRUCTIONS:**
1. Keep the text EXACTLY as written - do NOT expand, elaborate, or add content
2. Do NOT change the wording, sentence structure, or meaning
3. Only format it into lines with the speaker name
4. Add style hints [in brackets] ONLY where the original text clearly indicates tone (e.g., if text says "I'm excited", use [enthusiastically])
5. Split into natural speaking chunks (1-3 sentences per line)
6. Do NOT add transitions, questions, or conversational elements that aren't in the original

**Output Format:**
{speaker_name} [optional-style-if-obvious]: Exact text from original

**Example Input:**
"Artificial intelligence has been developing rapidly. Machine learning algorithms can now process vast amounts of data. This technology is transforming many industries."

**Example Output:**
Narrator: Artificial intelligence has been developing rapidly.
Narrator: Machine learning algorithms can now process vast amounts of data.
Narrator: This technology is transforming many industries.

Now convert the raw text above into this format. KEEP IT VERBATIM - do not add or change anything!`,

        multi: `You are a text formatter. Convert the following raw text into a dialogue format with MINIMAL changes.

**Context:**
- Number of speakers: {num_speakers}
- Language: {language_name}
- Target length: Match the original text length as closely as possible
- Speakers: {speakers_info}

**Raw Text to Convert:**
{raw_text}

**CRITICAL INSTRUCTIONS:**
1. Keep the text EXACTLY as written - do NOT expand, elaborate, or add content
2. Do NOT change the wording, sentence structure, or meaning
3. Distribute the existing text naturally between the {num_speakers} speakers
4. Add style hints [in brackets] ONLY where the original text clearly indicates tone
5. Split into natural speaking chunks (1-3 sentences per line)
6. Do NOT add questions, clarifications, or conversational back-and-forth that isn't in the original
7. Simply divide the existing content between speakers in a logical way

**Output Format:**
SpeakerName [optional-style-if-obvious]: Exact text from original

**Example Input:**
"Artificial intelligence has been developing rapidly. Machine learning algorithms can now process vast amounts of data. This technology is transforming many industries. Companies are investing billions in AI research."

**Example Output:**
Anna: Artificial intelligence has been developing rapidly.
Max: Machine learning algorithms can now process vast amounts of data.
Anna: This technology is transforming many industries.
Max: Companies are investing billions in AI research.

Now convert the raw text above into this format. KEEP IT VERBATIM - just distribute between speakers!`
    },

    // NATURAL: Light conversational touch
    natural: {
        single: `You are a narrator. Convert the following raw text into a natural narration with light conversational elements.

**Context:**
- Single speaker (monologue)
- Language: {language_name}
- Overall tone: {tone}
- Target length: {target_length}
- Speaker: {speakers_info}

**Raw Text to Convert:**
{raw_text}

**Instructions:**
1. Convert the text into a natural-sounding narration
2. Make MINOR adjustments for better flow (e.g., "Let me tell you about..." instead of just starting abruptly)
3. Add natural transitions between topics
4. Add style hints [in brackets] to enhance delivery
5. Keep content faithful to the original - don't add major new information
6. Aim for approximately {target_length} total

**Output Format:**
{speaker_name} [style]: Text

Now convert the text into a natural narration!`,

        multi: `You are a podcast script formatter. Convert the following raw text into a natural dialogue with light conversational elements.

**Context:**
- Number of speakers: {num_speakers}
- Language: {language_name}
- Overall tone: {tone}
- Target length: {target_length}
- Speakers: {speakers_info}

**Raw Text to Convert:**
{raw_text}

**Instructions:**
1. Distribute content naturally between the {num_speakers} speakers
2. Add light conversational elements (e.g., "That's interesting" or "Tell me more")
3. Add natural transitions and acknowledgments
4. Add style hints [in brackets] for better delivery
5. Keep the core content and facts from the original text
6. Aim for approximately {target_length} total
7. Each turn should be 1-4 sentences

**Output Format:**
SpeakerName [style]: Text

Now convert the text into a natural dialogue!`
    },

    // CONVERSATIONAL: Standard engaging dialogue (original)
    conversational: {
        single: `You are a narrator/audiobook reader. Convert the following raw text into a natural, engaging narration.

**Context:**
- Single speaker (monologue)
- Language: {language_name}
- Overall tone: {tone}
- Target length: {target_length}
- Speaker: {speakers_info}

**Raw Text to Convert:**
{raw_text}

**Instructions:**
1. Create a natural, engaging {target_length_desc} narration from the raw text
2. Format the text naturally for speaking, with appropriate pauses and emphasis
3. Add style hints in square brackets where appropriate (e.g., [thoughtfully], [enthusiastically], [calmly])
4. Maintain the {tone} tone throughout
5. Use the exact speaker name provided above
6. IMPORTANT: Generate enough content to match the target length of {target_length}. Expand on topics naturally with details and examples.
7. Make it engaging and natural to listen to

**Output Format (one line per section):**
SpeakerName [optional-style]: Text to be spoken

**Example:**
Narrator [warmly]: Welcome to today's story about artificial intelligence and how it's transforming our world.
Narrator [thoughtfully]: Let me start by explaining what AI really means...

Now convert the raw text above into this format for a single narrator. Remember to generate {target_length_desc} content!`,

        multi: `You are a podcast script formatter. Convert the following raw text into a structured dialogue script.

**Context:**
- Number of speakers: {num_speakers}
- Language: {language_name}
- Overall tone: {tone}
- Target length: {target_length}
- Speakers: {speakers_info}

**Raw Text to Convert:**
{raw_text}

**Instructions:**
1. Create a natural, engaging {target_length_desc} podcast script from the raw text
2. Split the content naturally into dialogue turns between the {num_speakers} speaker(s)
3. Each turn should be 1-4 sentences for natural conversational flow
4. Add appropriate style hints in square brackets (e.g., enthusiastically, calmly, thoughtfully)
5. Make it conversational, engaging, and maintain the {tone} tone
6. Use the exact speaker names provided above
7. IMPORTANT: Generate enough content to match the target length of {target_length}. Don't be brief - expand on topics naturally with details, examples, and explanations.
8. Include transitions, questions, clarifications, and natural back-and-forth between speakers
9. Add depth by exploring different angles, asking follow-up questions, and providing context

**Output Format (one line per dialogue turn):**
SpeakerName [style]: Text of what they say

**Example:**
Anna [enthusiastically]: Welcome to our show!
Max [professionally]: Today we discuss artificial intelligence and how it's transforming every aspect of our daily lives.
Anna [curiously]: That's fascinating! Can you break down what exactly makes AI so revolutionary for our listeners who might not be familiar with the technical details?
Max [thoughtfully]: Great question. Let me start with the basics and then we'll dive deeper into some specific examples...

Now convert the raw text above into this format. Remember to generate {target_length_desc} content - don't rush, take time to explore the topic thoroughly!`
    },

    // CREATIVE: Enhanced with examples and depth
    creative: {
        single: `You are a creative narrator who brings stories to life. Convert the following raw text into a rich, engaging narration.

**Context:**
- Single speaker (monologue)
- Language: {language_name}
- Overall tone: {tone}
- Target length: {target_length}
- Speaker: {speakers_info}

**Raw Text to Convert:**
{raw_text}

**Instructions:**
1. Create an engaging {target_length_desc} narration that brings the content to life
2. EXPAND on the original text with vivid examples, analogies, and explanations
3. Add storytelling elements to make it compelling
4. Use varied vocal delivery with rich style hints [in brackets]
5. Maintain the {tone} tone while adding personality
6. IMPORTANT: Significantly expand beyond the source material to reach {target_length}
7. Add context, background information, and practical examples
8. Make complex ideas accessible and interesting

**Output Format:**
{speaker_name} [expressive-style]: Enhanced text with examples

**Example:**
Narrator [with wonder]: Imagine a world where machines can think‚Äînot just calculate, but truly understand and learn.
Narrator [thoughtfully]: That's the promise of artificial intelligence. Let me paint you a picture of what this really means...
Narrator [enthusiastically]: Think about your smartphone. Every time you use voice commands, that's AI at work!

Now create a rich, expanded narration from the raw text!`,

        multi: `You are a creative podcast producer. Convert the following raw text into a dynamic, engaging dialogue with depth.

**Context:**
- Number of speakers: {num_speakers}
- Language: {language_name}
- Overall tone: {tone}
- Target length: {target_length}
- Speakers: {speakers_info}

**Raw Text to Convert:**
{raw_text}

**Instructions:**
1. Create a dynamic {target_length_desc} podcast that significantly expands on the original text
2. ENHANCE the content with concrete examples, analogies, and real-world scenarios
3. Create engaging back-and-forth with questions, reactions, and deeper exploration
4. Add storytelling elements and personal touches
5. Use rich style hints [in brackets] for expressive delivery
6. Maintain the {tone} tone while adding energy and personality
7. IMPORTANT: Expand substantially to reach {target_length}‚Äîdon't just read the facts, discuss them!
8. Include "aha moments", explanations for beginners, and expert insights
9. Make speakers play off each other naturally with reactions and follow-ups

**Output Format:**
SpeakerName [expressive-style]: Enhanced dialogue with examples

**Example:**
Anna [excitedly]: You know what blows my mind about AI? 
Max [intrigued]: Tell me!
Anna [enthusiastically]: It's not just about robots‚Äîit's in everything! Your Netflix recommendations? That's AI learning what you love.
Max [thoughtfully]: Exactly! And here's what most people don't realize about how it actually works...

Now create a rich, engaging dialogue that brings the content to life!`
    }
};

const defaultPromptTemplate = promptTemplates.conversational.multi;

modeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
        modeButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentMode = this.dataset.mode;
        
        if (currentMode === 'ai') {
            aiModeContent.style.display = 'block';
            manualModeContent.style.display = 'none';
        } else {
            aiModeContent.style.display = 'none';
            manualModeContent.style.display = 'block';
        }
    });
});

promptEditorToggle.addEventListener('click', function() {
    const isExpanded = promptEditorContent.classList.contains('expanded');
    if (isExpanded) {
        promptEditorContent.classList.remove('expanded');
        promptToggleIcon.textContent = '‚ñº';
    } else {
        promptEditorContent.classList.add('expanded');
        promptToggleIcon.textContent = '‚ñ≤';
    }
});

resetPromptBtn.addEventListener('click', function() {
    loadPromptTemplate(promptPresetSelect.value);
});

// Function to load the appropriate prompt template
function loadPromptTemplate(presetName) {
    const numSpeakers = parseInt(numSpeakersSelect.value);
    const isSingleSpeaker = numSpeakers === 1;
    const template = promptTemplates[presetName];
    
    if (template) {
        systemPromptEditor.value = isSingleSpeaker ? template.single : template.multi;
    }
}

// Event listener for prompt preset changes
promptPresetSelect.addEventListener('change', function() {
    loadPromptTemplate(this.value);
});

useManualScriptBtn.addEventListener('click', function() {
    const scriptText = manualScriptInput.value.trim();
    if (!scriptText) {
        alert('Please enter a script first.');
        return;
    }
    
    formattedDialoguePreview.value = scriptText;
    formattedPreviewCard.style.display = 'block';
    formattedPreviewCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
});

function createSpeakerConfig(index) {
    const speaker = defaultSpeakers[index] || { 
        name: `Speaker${index + 1}`, 
        voice: 'Kore', 
        personality: 'neutral' 
    };
    
    const configDiv = document.createElement('div');
    configDiv.className = 'speaker-config';
    configDiv.dataset.speakerIndex = index;
    
    // UPDATED: Label for single speaker
    const speakerLabel = index === 0 && parseInt(numSpeakersSelect.value) === 1 
        ? 'Speaker (Narrator/Voice)'
        : `Speaker ${index + 1}`;
    
    configDiv.innerHTML = `
        <div class="speaker-config-header">${speakerLabel}</div>
        <div class="speaker-config-row">
            <div>
                <label class="form-label" style="font-size: 0.8rem;">Name</label>
                <input type="text" class="form-control form-control-sm speaker-name" value="${speaker.name}">
            </div>
            <div>
                <label class="form-label" style="font-size: 0.8rem;">Voice</label>
                <select class="form-select form-select-sm speaker-voice">
                    <optgroup label="Female">
                        ${geminiVoiceOptions.female.map(v => 
                            `<option value="${v}" ${v === speaker.voice ? 'selected' : ''}>${v}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Male">
                        ${geminiVoiceOptions.male.map(v => 
                            `<option value="${v}" ${v === speaker.voice ? 'selected' : ''}>${v}</option>`
                        ).join('')}
                    </optgroup>
                    <optgroup label="Neutral">
                        ${geminiVoiceOptions.neutral.map(v => 
                            `<option value="${v}" ${v === speaker.voice ? 'selected' : ''}>${v}</option>`
                        ).join('')}
                    </optgroup>
                </select>
            </div>
            <div>
                <label class="form-label" style="font-size: 0.8rem;">Personality</label>
                <input type="text" class="form-control form-control-sm speaker-personality" 
                       value="${speaker.personality}" 
                       placeholder="e.g., friendly, professional...">
            </div>
        </div>
    `;
    
    return configDiv;
}

function updateSpeakerConfigs() {
    const numSpeakers = parseInt(numSpeakersSelect.value);
    speakersConfigContainer.innerHTML = '';
    
    for (let i = 0; i < numSpeakers; i++) {
        speakersConfigContainer.appendChild(createSpeakerConfig(i));
    }
}

function collectSpeakerDescriptions() {
    const configs = speakersConfigContainer.querySelectorAll('.speaker-config');
    const descriptions = [];
    
    configs.forEach(config => {
        descriptions.push({
            name: config.querySelector('.speaker-name').value.trim(),
            voice: config.querySelector('.speaker-voice').value,
            personality: config.querySelector('.speaker-personality').value.trim()
        });
    });
    
    return descriptions;
}

numSpeakersSelect.addEventListener('change', function() {
    updateSpeakerConfigs();
    // Also update the prompt template to match single vs multi speaker
    loadPromptTemplate(promptPresetSelect.value);
});

// Initialize speaker configs and load default template
updateSpeakerConfigs();
loadPromptTemplate('conversational');

formatWithAiBtn.addEventListener('click', async () => {
    const rawText = rawPodcastTextInput.value.trim();
    
    if (!rawText) {
        alert('Please enter some text to format.');
        return;
    }
    
    formatWithAiBtn.disabled = true;
    formatWithAiBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Formatting with AI...';
    
    try {
        const response = await fetch('/format-dialogue-with-llm', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                raw_text: rawText,
                num_speakers: parseInt(numSpeakersSelect.value),
                speaker_descriptions: collectSpeakerDescriptions(),
                language: podcastLanguageSelect.value,
                tone: podcastToneSelect.value,
                script_length: scriptLengthSelect.value,
                custom_prompt: systemPromptEditor.value
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        formattedDialoguePreview.value = data.raw_formatted_text;
        formattedPreviewCard.style.display = 'block';
        
        formattedPreviewCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
    } catch (error) {
        console.error('Formatting error:', error);
        alert('Error formatting dialogue: ' + error.message);
    } finally {
        formatWithAiBtn.disabled = false;
        formatWithAiBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"></path></svg> ‚ú® Format with AI';
    }
});

generateFromFormattedBtn.addEventListener('click', async () => {
    const formattedText = formattedDialoguePreview.value.trim();
    
    if (!formattedText) {
        alert('No formatted dialogue to generate.');
        return;
    }
    
    const dialogue = [];
    const speakerDescriptions = collectSpeakerDescriptions();
    const speakerVoiceMap = {};
    speakerDescriptions.forEach(desc => {
        speakerVoiceMap[desc.name] = desc.voice;
    });
    
    for (const line of formattedText.split('\n')) {
        const trimmedLine = line.trim();
        if (!trimmedLine || trimmedLine.startsWith('#') || trimmedLine.startsWith('**')) {
            continue;
        }
        
        if (trimmedLine.includes(':')) {
            const parts = trimmedLine.split(':', 1);
            const speakerPart = parts[0].trim();
            const textPart = trimmedLine.substring(parts[0].length + 1).trim();
            
            let speaker = speakerPart;
            let style = '';
            
            if (speakerPart.includes('[') && speakerPart.includes(']')) {
                speaker = speakerPart.split('[')[0].trim();
                style = speakerPart.split('[')[1].split(']')[0].trim();
            }
            
            const voice = speakerVoiceMap[speaker] || 'Kore';
            
            if (textPart) {
                dialogue.push({
                    speaker: voice,
                    style: style,
                    text: textPart
                });
            }
        }
    }
    
    if (dialogue.length === 0) {
        alert('Could not parse any dialogue. Please check the format.');
        return;
    }
    
    generateFromFormattedBtn.disabled = true;
    generateFromFormattedBtn.textContent = 'üéôÔ∏è Generating...';
    llmPodcastResultContainer.style.display = 'none';
    
    try {
        const response = await fetch('/generate-gemini-podcast', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dialogue: dialogue,
                language: podcastLanguageSelect.value
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }
        
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        llmPodcastAudioSource.src = audioUrl;
        llmPodcastAudio.load();
        
        downloadLlmPodcastBtn.href = audioUrl;
        
        llmPodcastResultContainer.style.display = 'block';
        llmPodcastResultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
    } catch (error) {
        console.error('Podcast generation error:', error);
        alert('Error generating podcast: ' + error.message);
    } finally {
        generateFromFormattedBtn.disabled = false;
        generateFromFormattedBtn.textContent = 'üéôÔ∏è Generate Podcast';
    }
});
</script>
{% endif %}
{% endblock %}